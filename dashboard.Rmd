---
title: "dashboard"
author: "shichi"
date: "`r Sys.time()`"
output: 
  flexdashboard::flex_dashboard:
    orientation: "row"
    theme: flatly

---

```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(data.table)
library(formattable)
library(tidyr)
library(plotly)
output.dt <- fread("data.csv", encoding = "UTF-8")
```


row {data-height=20%}
----

### card1 {data-width=35%}

```{r}
asset_fresh <- output.dt$asset %>% .[length(.)]
valueBox(asset_fresh, 
         caption = "Total Asset",
         icon = "glyphicon glyphicon-yen",
         color = ifelse(asset_fresh < 2000000, "warning", "success")
         )
```

### card2 {data-width=35%}

```{r}
stock_fresh <- output.dt$amount[output.dt$details == "Stock"] %>% sum()
valueBox(stock_fresh, 
         caption = "Total Stock",
         icon = "glyphicon glyphicon-tint",
         color = ifelse(stock_fresh > 1000000, "warning", "success")
         )
```

### card3 {data-width=30%}

```{r}
valueBox(150000, 
         caption = "Tax limit",
         icon = "glyphicon glyphicon-flag",
         color = ifelse(150000 < 100000, "warning", "success")
         )
```

column {data-height=50%}
----

### Assets  {data-width=70%}

```{r}
asset.dt <- output.dt %>% 
  select(ds, amount, details) %>% 
  data.table(. , tmp = paste0(.$ds ,.$details)) %>% 
  group_by(tmp) %>% 
  summarise(total = sum(amount))

asset.dt <-  asset.dt %>% 
  data.table(ds = as.Date(substr(.$tmp, 1, 10)), amount = .$total, details = substr(.$tmp, 11, 20)) %>% 
  dcast(ds ~ details, value.var = "amount") %>% 
  data.frame()
asset.dt[is.na(asset.dt)] <- 0


for(i in 1:nrow(asset.dt)){
  for(j in 2:ncol(asset.dt))
    if(i != 1){
      asset.dt[i,j] <- asset.dt[i-1,j] + asset.dt[i,j]
    }
}
for(i in 1:nrow(asset.dt)){
  for(j in 3:ncol(asset.dt)){
    asset.dt[i,j] <- asset.dt[i,j-1] + asset.dt[i,j]
  }
}

p <- plot_ly(asset.dt, x = ~ds, y = ~Yucho, name = 'Yucho', type = 'scatter', mode = 'none', fill = 'tozeroy', fillcolor = '#97D1C7') %>%
  add_trace(y = ~Stock, name = 'Stock', fillcolor = '#F58A88') %>%
  add_trace(y = ~Mizuho, name = 'Mizuho', fillcolor = '#73ABC2') %>%
  layout(xaxis = list(showgrid = TRUE),
         yaxis = list(title = "Total Assets",
                      showgrid = TRUE))

p


```

### Pie  {data-width=30%}

```{r}
asset.dt <- output.dt %>% 
  select(ds, amount, details) %>% 
  data.table(. , tmp = paste0(.$ds ,.$details)) %>% 
  group_by(tmp) %>% 
  summarise(total = sum(amount))

asset.dt <-  asset.dt %>% 
  data.table(ds = as.Date(substr(.$tmp, 1, 10)), amount = .$total, details = substr(.$tmp, 11, 20)) %>% 
  dcast(ds ~ details, value.var = "amount") %>% 
  data.frame()
asset.dt[is.na(asset.dt)] <- 0


for(i in 1:nrow(asset.dt)){
  for(j in 2:ncol(asset.dt))
    if(i != 1){
      asset.dt[i,j] <- asset.dt[i-1,j] + asset.dt[i,j]
    }
}
for(i in 1:nrow(asset.dt)){
  for(j in 3:ncol(asset.dt)){
    asset.dt[i,j] <- asset.dt[i,j-1] + asset.dt[i,j]
  }
}
asset.dt[,2:4] <- asset.dt[,2:4]/apply(asset.dt[,2:4],1,sum)
for(i in 1:nrow(asset.dt)){
  for(j in 3:ncol(asset.dt)){
    asset.dt[i,j] <- asset.dt[i,j-1] + asset.dt[i,j]
  }
}


p <- plot_ly(asset.dt, x = ~ds, y = ~Yucho, name = 'Yucho', type = 'scatter', mode = 'none', fill = 'tozeroy', fillcolor = '#97D1C7', showlegend = FALSE) %>%
  add_trace(y = ~Stock, name = 'Stock', fillcolor = '#F58A88') %>%
  add_trace(y = ~Mizuho, name = 'Mizuho', fillcolor = '#73ABC2') %>%
  layout(xaxis = list(showgrid = TRUE),
         yaxis = list(title = "Total Assets",
                      showgrid = TRUE))

p
```


column {data-height=40%}
----

### Data {data-width=50%}

```{r}

formattable(output.dt, list(
  asset = color_bar("pink"),
  amount = formatter("span",
                      style = x ~ ifelse(x < 0 , formattable::style(color = "red"), formattable::style(color = "green")))

))

```
